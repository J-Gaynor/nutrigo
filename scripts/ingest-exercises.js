const fs = require('fs');
const path = require('path');

// --- Mappings ---

// Map raw "primaryMuscles" to our internal IDs if needed, 
// or just clean them up. For now, we'll keep them as strings 
// but ensure they are consistent.
const MUSCLE_MAP = {
    "abdominals": "abs",
    "abductors": "legs", // Simplify
    "adductors": "legs",
    "biceps": "arms",
    "calves": "legs",
    "chest": "chest",
    "forearms": "arms",
    "glutes": "legs",
    "hamstrings": "legs",
    "lats": "back",
    "lower back": "back",
    "middle back": "back",
    "neck": "shoulders", // Close enough
    "quadriceps": "legs",
    "shoulders": "shoulders",
    "traps": "back",
    "triceps": "arms"
};

// Map raw "category" to broadly match our MET intensity logic or just generic types
const CATEGORY_MAP = {
    "strength": 3.0,     // Default weightlifting MET
    "stretching": 2.0,   // Low intensity
    "plyometrics": 8.0,  // High intensity
    "strongman": 6.0,    // Heavy lifting
    "powerlifting": 6.0,
    "cardio": 8.0,
    "olympic weightlifting": 6.0
};

const INPUT_FILE = path.join(__dirname, '../src/data/exercises.json');
const OUTPUT_FILE = path.join(__dirname, '../src/data/exercises_normalized.ts');

try {
    const rawData = fs.readFileSync(INPUT_FILE, 'utf8');
    const exercises = JSON.parse(rawData);

    console.log(`Loaded ${exercises.length} exercises from raw JSON.`);

    const normalized = exercises.map(ex => {
        // 1. Determine MET based on category
        let met = CATEGORY_MAP[ex.category] || 3.0;

        // Manual MET overrides for common cardio
        const nameLower = ex.name.toLowerCase();
        if (nameLower.includes('run') || nameLower.includes('treadmill')) met = 8.0;
        else if (nameLower.includes('walk')) met = 3.5;
        else if (nameLower.includes('bike') || nameLower.includes('cycling')) met = 7.0;
        else if (nameLower.includes('rowing')) met = 7.0;

        // 2. Map Muscle Group (Use first primary muscle)
        // This is for future filtering if we want it
        const primaryMuscle = ex.primaryMuscles && ex.primaryMuscles.length > 0
            ? ex.primaryMuscles[0]
            : 'other';

        return {
            id: ex.id,
            name: ex.name,
            met: met,
            // category: ex.category, // Optional: keep raw category
            // muscle: primaryMuscle  // Optional: keep raw muscle
        };
    });

    // Remove duplicates by ID just in case
    const unique = Array.from(new Map(normalized.map(item => [item.id, item])).values());

    console.log(`Processed ${unique.length} unique exercises.`);

    const fileContent = `// AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
// Generated by scripts/ingest-exercises.js used to seed ExerciseDB data.

export interface ExerciseOption {
    id: string;
    name: string;
    met: number;
}

export const EXERCISE_DB: ExerciseOption[] = ${JSON.stringify(unique, null, 4)};
`;

    fs.writeFileSync(OUTPUT_FILE, fileContent);
    console.log(`Successfully wrote to ${OUTPUT_FILE}`);

} catch (error) {
    console.error('Error processing exercises:', error);
}
